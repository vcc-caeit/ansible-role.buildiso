---
- name: Fetch ISO checksum
  uri:
    url: "{{ buildiso_input | dirname + '/SHA256SUMS' }}"
    return_content: true
  register: buildiso_download_checksum

- name: Download ISO image
  get_url:
    url: "{{ buildiso_input }}"
    dest: "{{ buildiso_image }}"
    checksum: "{{ 'sha256:' + buildiso_download_checksum.content | regex_replace('\n', '') | \
               regex_replace('^.*([a-z0-9]{64})\\ \\*' + buildiso_image | \
               basename + '.*$', '\\1') }}"
  register: buildiso_download_iso

- name: Ensure temporary directories
  file:
    path: "{{ buildiso_mkdir }}"
    state: directory
  loop:
    - "{{ buildiso_backing }}"
    - "{{ buildiso_readonly }}"
    - "{{ buildiso_writable }}"
  loop_control:
    loop_var: buildiso_mkdir

- name: Enumerate current mounts
  setup:
    gather_subset:
      - '!min'
      - hardware
    filter: ansible_mounts

- name: Unmount directories when ISO file changed
  command: "{{ 'umount ' + buildiso_umount | splitext | first + '.writable ' + buildiso_umount }}"
  args:
    warn: false
    removes: "{{ buildiso_readonly + '/.disk/info' }}"
  loop: "{{ ansible_mounts | json_query('[?mount==`' + buildiso_readonly + '`].mount') }}"
  loop_control:
    loop_var: buildiso_umount
    label: "{{ buildiso_readonly | splitext | first + '.writable, ' + buildiso_umount }}"
  when:
    - buildiso_download_iso is changed

- name: Ensure directories are mounted
  command: "{{ 'mount ' + buildiso_mount.args + ' ' + buildiso_mount.src + ' ' + buildiso_mount.dest }}"
  args:
    warn: false
    creates: "{{ buildiso_mount.dest + '/.disk/info' }}"
  loop:
    - src: "{{ buildiso_image }}"
      dest: "{{ buildiso_readonly }}"
      args: '-o loop,ro'
    - src: none
      dest: "{{ buildiso_writable }}"
      args: "{{ '-t aufs -o br=' + buildiso_backing + ':' + buildiso_readonly }}"
  loop_control:
    loop_var: buildiso_mount
    label: "{{ buildiso_mount.dest }}"

- name: Enumerate release codename
  stat:
    path: "{{ buildiso_readonly + '/dists/stable' }}"
    follow: false
  register: buildiso_dist_check

- name: Define buildiso_dist variable
  set_fact:
    buildiso_dist: "{{ buildiso_dist_check.stat.lnk_target }}"

- name: Ensure image configuration
  template:
    src: "{{ item + '.j2' }}"
    dest: "{{ buildiso_writable + '/' + item | regex_replace('ubuntu', buildiso_preseed | default('ubuntu')) }}"
  loop:
    - preseed/ubuntu.seed
    - isolinux/txt.cfg
    - boot/grub/grub.cfg
  loop_control:
    label: "{{ '/' + item | regex_replace('ubuntu', buildiso_preseed | default('ubuntu')) }}"
  register: buildiso_template

- name: Create file target directory
  file:
    path: "{{ buildiso_writable + '/extras/' + item }}"
    state: directory
  loop: "{{ buildiso_files | default([]) | json_query('[].src') | map('dirname') | list | unique }}"
  loop_control:
    label: "{{ '/extras/' + item }}"
  when: buildiso_files is defined

- name: Copy files to image
  copy:
    src: "{{ playbook_dir + '/' + item.src }}"
    dest: "{{ buildiso_writable + '/extras/' + item.dest | default(item.src) }}"
    mode: "{{ item.mode | default('preserve') }}"
  loop: "{{ buildiso_files | default([]) }}"
  loop_control:
    label: "{{ '/extras/' + item.src }}"
  register: buildiso_copy

- name: Sync PPA to image
  include_tasks: syncppa.yml
  when: buildiso_ppa is defined

- name: Ensure correct checksums in md5sum.txt
  lineinfile:
    path: "{{ buildiso_writable }}/md5sum.txt"
    regexp: "^[a-z0-9]{32}  {{ item.path | regex_replace(buildiso_writable, '.') }}$"
    line: >-
      {%- if item.csum is not none -%}
      {{ item.csum + '  ' + item.path | regex_replace(buildiso_writable, '.') }}
      {%- else -%}
      {{ lookup('pipe', 'md5sum ' + item.path) | regex_replace(buildiso_writable, '.') }}
      {%- endif -%}
    create: true
    state: present
  loop: >-
    {{ lookup('filetree', buildiso_writable + '/extras/', wantlist=true) |
    json_query('[*].{dest: src, state: state}') | difference(buildiso_copy.results |
    json_query('[*].{dest: dest, state: state}')) | union (buildiso_copy.results) | union(buildiso_template.results) |
    json_query('[?state==`file`].{path: dest, csum: md5sum}') | unique }}
  loop_control:
    label: "{{ item.path | regex_replace(buildiso_writable) }}"
  register: buildiso_checksum

- name: Create ISO image and make UEFI bootable
  command: "{{ buildiso_create.cmd + ' ' + buildiso_create.args }}"
  loop:
    - cmd: mkisofs
      args: >-
        -D -r -V "{{ buildiso_name | default('Ubuntu') }}" -cache-inodes -J -l -b isolinux/isolinux.bin -c isolinux/boot.cat
        -no-emul-boot -boot-load-size 4 -boot-info-table -eltorito-alt-boot -e boot/grub/efi.img -no-emul-boot
        -o {{ buildiso_output }} {{ buildiso_writable }}
    - cmd: isohybrid
      args: "-t 0 -u {{ buildiso_output }}"
  loop_control:
    loop_var: buildiso_create
    label: "{{ buildiso_create.cmd }}"
  when: (buildiso_ppa_checksum is defined and buildiso_ppa_checksum is changed) or
         buildiso_checksum is changed or
         buildiso_download_iso is changed

- name: Ensure correct manifest file
  fetch:
    src: "{{ buildiso_writable }}/casper/filesystem.manifest"
    dest: "{{ buildiso_output | splitext | first }}.manifest"
    flat: true

- name: Run cleanup tasks
  include_tasks: cleanup.yml
  tags:
    - never
    - cleanup
